services:
  postgres:
    env_file:
      - .env
    image: ${POSTGRES_IMAGE}
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - 5432:5432
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${POSTGRES_USER}", "-d", "${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  hapi-fhir:
    env_file:
      - .env
    image: ${HAPI_IMAGE}
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Spring Boot datasource properties
      - spring.datasource.url=jdbc:postgresql://postgres:5432/${POSTGRES_DB}
      - spring.datasource.username=${POSTGRES_USER}
      - spring.datasource.password=${POSTGRES_PASSWORD}
      - spring.datasource.driverClassName=org.postgresql.Driver
      - spring.jpa.hibernate.ddl-auto=${HIBERNATE_DDL_AUTO:-update}
      - spring.jpa.properties.hibernate.dialect=ca.uhn.fhir.jpa.model.dialect.HapiFhirPostgresDialect
      # Server base URL for fullUrl in responses
      - hapi.fhir.server_address=https://${HOST}:${PORT}
      # Serve FHIR from root path instead of /fhir
      - hapi.fhir.server.path=/
      - HAPI_FHIR_MAX_HEAP=${HAPI_MAX_HEAP}
      - HAPI_FHIR_DEFAULT_PAGE_SIZE=${HAPI_PAGE_SIZE}
      - HAPI_FHIR_SERVER_PORT=${HAPI_SERVER_PORT}
      - HAPI_FHIR_SECURITY_ENABLED=${HAPI_SECURITY_ENABLED}
      - HAPI_FHIR_OPENAPI_ENABLED=false
      - HAPI_FHIR_CORS_ALLOWED_ORIGINS=*
      - HAPI_FHIR_REUSE_CACHED_SEARCH_RESULTS_MILLIS=5000
      - HAPI_FHIR_ALLOW_MULTIPLE_DELETE=true
      - HAPI_FHIR_ALLOW_EXTERNAL_REFERENCES=true
      - HAPI_FHIR_ALLOW_CASCADING_DELETES=true
      - HAPI_FHIR_EXPUNGE_ENABLED=false
      - HAPI_FHIR_NARRATIVE_ENABLED=true
      - HAPI_FHIR_VALIDATION_REQUESTS_ENABLED=true
      - HAPI_FHIR_SUBSCRIPTION_RESTHOOK_ENABLED=true
      - HAPI_FHIR_BULK_EXPORT_ENABLED=true
      - HAPI_FHIR_CDSHOOKS_ENABLED=false
      - HAPI_FHIR_LASTN_ENABLED=true
      - HAPI_FHIR_FILTER_SEARCH_ENABLED=true
      - HAPI_FHIR_GRAPHQL_ENABLED=false
      - JAVA_OPTS=-Xmx8g
    ports:
      - ${HAPI_SERVER_PORT}:${HAPI_SERVER_PORT}
    volumes:
      - ./seed-data:/seed-data
    deploy:
      resources:
        limits:
          memory: 8g
    # healthcheck:
    #   test: ["CMD-SHELL", "curl -f http://localhost:${HAPI_SERVER_PORT}/fhir/metadata > /dev/null"]
    #   interval: 10s
    #   timeout: 120s
    #   retries: 6

  nginx:
    env_file:
      - .env
    image: nginx:1.26
    restart: unless-stopped
    depends_on: 
      hapi-fhir:
        condition: service_started
        # condition: service_healthy
    ports:
      - ${NGINX_HTTP_PORT}:80
      - ${PORT}:${PORT}
    volumes:
      - ./nginx/nginx.tmpl:/etc/nginx/nginx.tmpl:ro
      - ./nginx/certs:/etc/nginx/certs:ro
      - ./letsencrypt:/etc/letsencrypt:ro
      - ./nginx/certbot:/var/www/certbot:ro
    command: |
      /bin/sh -c "if [ -f /etc/letsencrypt/live/${LETSENCRYPT_DOMAIN}/fullchain.pem ]; then
        export SSL_CERT_PATH=/etc/letsencrypt/live/${LETSENCRYPT_DOMAIN}/fullchain.pem
        export SSL_KEY_PATH=/etc/letsencrypt/live/${LETSENCRYPT_DOMAIN}/privkey.pem
      fi
      envsubst '$${HAPI_SERVER_PORT} $${PORT} $${NGINX_HTTP_PORT} $${SSL_CERT_PATH} $${SSL_KEY_PATH} $${LETSENCRYPT_DOMAIN} $${NGINX_MAX_BODY_SIZE}' < /etc/nginx/nginx.tmpl > /etc/nginx/nginx.conf && nginx -g 'daemon off;'"
    healthcheck:
      test: ["CMD-SHELL", "curl -k https://localhost:${PORT}/metadata > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 6

  certbot:
    env_file:
      - .env
    image: certbot/certbot:v5.1.0
    volumes:
      - ./letsencrypt:/etc/letsencrypt
      - ./letsencrypt/lib:/var/lib/letsencrypt
      - ./letsencrypt/log:/var/log/letsencrypt
      - ./nginx/certbot:/var/www/certbot

volumes:
  postgres_data:
